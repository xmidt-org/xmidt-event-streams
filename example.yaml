# SPDX-FileCopyrightText: 2023 Comcast Cable Communications Management, LLC
# SPDX-License-Identifier: LicenseRef-COMCAST

# Default configuration for EventStream service
# This file contains all available configuration options with their default values
# 
# Configuration can be customized by:
# 1. Creating a custom YAML file and using the --config flag
# 2. Setting environment variables (see individual field comments for env var names)
# 3. Overriding specific sections in additional config files
#
# The service accepts both JSON and MessagePack formatted WRP messages at the /api/events endpoint
#
# Example usage:
#   ./eventstream --config /path/to/custom.yaml
#   ./eventstream --config default.yaml --config overrides.yaml
#
# For testing with curl:
#   curl -X POST -H "Content-Type: application/json" \
#        -u "eventstream:eventstream-password" \
#        -d '{"msg_type": 4, "source": "dns:test.example.com", "dest": "event:device-status/mac:112233445566/online"}' \
#        http://localhost:8080/api/events

# Logging configuration
logging:
  level: "info"
  development: false
  disableCaller: false
  disableStacktrace: false
  encoding: "json"
  outputPaths:
    - "stdout"
  errorOutputPaths:
    - "stderr"
  encoderConfig:
    timeKey: "ts"
    levelKey: "level"
    nameKey: "logger"
    callerKey: "caller"
    messageKey: "msg"
    stacktraceKey: "stacktrace"
    levelEncoder: "lowercase"
    timeEncoder: "iso8601"
    durationEncoder: "string"
    callerEncoder: "short"

# Distributed tracing configuration
tracing:
  applicationName: "eventStream"

# Prometheus metrics configuration
prometheus:
  defaultNamespace: "anemoi"
  defaultSubsystem: "eventstream"

# Prometheus HTTP handler configuration
prometheusHandler:
  instrumentMetricHandler: true
  maxRequestsInFlight: 5
  timeout: "5s"

# Server configurations
servers:
  # Health check server
  health:
    http:
      network: "tcp"
      address: ":80"
    path: "/"

  # Metrics server
  metrics:
    http:
      network: "tcp"
      address: "127.0.0.1:9361"
    path: "/metrics"

  # Pprof debugging server
  pprof:
    http:
      network: "tcp"
      address: "127.0.0.1:9999"
    path: "/debug/pprof/"

  # Primary application server
  primary:
    http:
      network: "tcp"
      address: "127.0.0.1:8080"

  # Alternate application server
  alternate:
    http:
      network: "tcp"
      address: "127.0.0.1:9090"

# Route configurations
routes:
  events:
    path: "/api/events"
    server: "primary"

# Request handler configuration
requestHandler:
  maxOutstanding: 0  # 0 means no limit

# Authentication configuration
auth:
  isBasic: true  # Set to false to use JWT authentication instead
  
  # Basic authentication configuration (for testing & local development)
  basic:
    username: "eventstream"                      # Basic auth username
    password: "eventstream-password"             # Basic auth password
    upstreamUsername: ""                         # Optional upstream service username
    upstreamPassword: ""                         # Optional upstream service password
  
  # JWT authentication configuration (used when isBasic: false)
  jwt:
    publicKeyUrl: "https://sat-stg.codebig2.net/v2/sign-keys/available"  # Public key endpoint
    keyRefreshInterval: 1                        # Key refresh interval in hours
    serviceCapabilities:                         # Required JWT capabilities
      - "eventstream:write"
    tokenUrl: ""                                 # OAuth token endpoint (for upstream auth)
    clientId: ""                                 # OAuth client ID (for upstream auth)
    clientSecret: ""                             # OAuth client secret (for upstream auth)

# Filter manager configuration
filterManager:
  deliveryRetries: 3
  defaultQueueSize: 1000
  defaultBatchSize: 100
  defaultMaxWorkers: 1000
  
  # Filter configurations
  filters:
    - # Example: Device status events filter for Kinesis
      stream:
        streamName: "comcast-cl.device-status.local"
        config:
          endpoint: "http://localhost:4567"       # Kinesis endpoint
          region: "local"                         # AWS region
          access_key: "accessKey"                  # AWS access key
          secret_key: "secretKey"                  # AWS secret key
          session_token: "sessionToken"            # AWS session token (optional)
          version: "1.0"                          # Stream version
      
      # Alternative streams for failover (optional)
      altStreams: []
      
      # Event patterns to match using regex
      events:
        - "device-status.*"                       # Matches device-status/online, device-status/offline, etc.
        # - "device-.*"                           # Would match any device events
        # - "boot-time"                           # Would match specific boot-time events
      
      # Metadata filtering configuration
      metadata:
        deviceIds: []                             # Device ID patterns using regex (empty means all devices)
        # deviceIds:                              # Example device ID patterns:
        #   - "mac:.*"                            # Match all MAC addresses
        #   - "uuid:550e8400-.*"                  # Match specific UUID patterns
      
      # Destination type (kinesis, webhook, etc.)
      destType: "kinesis"
      
      # Stream version identifier
      streamVersion: "1.0"
      
      # Performance tuning (optional - will use defaults if not specified)
      queueSize: 100     # Number of events to buffer before dropping (default: 1000)
      batchSize: 1       # Number of events to batch together (default: 100)
      maxWorkers: 100    # Maximum concurrent workers (default: 1000)

    # Additional filter example (commented out):
    # - stream:
    #     streamName: "comcast-cl.boot-events.prod"
    #     config:
    #       Endpoint: "https://kinesis.us-east-1.amazonaws.com"
    #       Region: "us-east-1"
    #       AccessKey: "${AWS_ACCESS_KEY}"        # Environment variable reference
    #       SecretKey: "${AWS_SECRET_KEY}"
    #       Version: "2.0"
    #   events:
    #     - "boot-time"
    #     - "firmware-update.*"
    #   metadata:
    #     deviceIds:
    #       - "mac:112233.*"                      # Only specific MAC prefix
    #   destType: "kinesis"
    #   streamVersion: "2.0"